# Combined Baseline JSON Schema Reference

This document describes the structure and attributes of the `combined_baseline.json` file generated by `scripts/generate_baseline.py`.

## Overview

The combined baseline aggregates statistics from multiple trusted players to establish expected ranges for fair play metrics. It's used as a reference when evaluating other players for potential anomalies.

---

## Top-Level Attributes

| Attribute | Type | Description |
|-----------|------|-------------|
| `status` | string | Generation status: `"success"` or `"no_data"` |
| `generated_at` | string | ISO 8601 timestamp of generation |
| `num_players` | int | Number of players successfully processed |
| `player_usernames` | list[str] | Usernames of all players included |
| `total_games` | int | Total games across all players |
| `total_trustworthy_games` | int | Games vs non-banned opponents |
| `total_untrustworthy_games` | int | Games vs banned opponents |
| `total_positions` | int | Total positions extracted for analysis |
| `total_unique_opponents` | int | Unique opponents across all players |
| `total_banned_opponents` | int | Opponents with fair play violations |

---

## `elo_baseline`

Elo rating pattern statistics aggregated across all trusted players.

| Attribute | Type | Description |
|-----------|------|-------------|
| `win_rate_mean` | float | Average win rate (0.0-1.0) |
| `win_rate_std` | float | Standard deviation of win rates |
| `upset_rate_mean` | float | Average rate of wins vs higher-rated opponents |
| `upset_rate_std` | float | Standard deviation of upset rates |
| `manipulation_score_mean` | float | Average manipulation score (0.0-1.0) |
| `manipulation_score_std` | float | Standard deviation |
| `manipulation_score_max` | float | Maximum manipulation score observed |

**Usage**: Compare a suspect player's manipulation score against `mean + 2*std` to identify outliers.

---

## `result_baseline`

Game result pattern statistics.

| Attribute | Type | Description |
|-----------|------|-------------|
| `checkmate_rate_mean` | float | Average rate of games ending in checkmate |
| `checkmate_rate_std` | float | Standard deviation |
| `entropy_mean` | float | Average result entropy (randomness measure) |
| `entropy_std` | float | Standard deviation |

**Note**: Higher entropy indicates more random win/loss patterns (expected for fair players).

---

## `timeout_baseline`

Timeout win analysis, particularly when behind on material.

| Attribute | Type | Description |
|-----------|------|-------------|
| `timeout_win_rate_mean` | float | Average rate of wins by timeout |
| `timeout_win_rate_std` | float | Standard deviation |
| `behind_rate_mean` | float | Rate of timeout wins while behind on material |
| `behind_rate_std` | float | Standard deviation |
| `way_behind_rate_mean` | float | Rate of timeout wins while significantly behind |
| `way_behind_rate_std` | float | Standard deviation |

**Usage**: High `behind_rate` may indicate stalling tactics in lost positions.

---

## `termination_baseline`

Detailed game termination statistics from PGN Termination field.

| Attribute | Type | Description |
|-----------|------|-------------|
| `checkmate_rate_mean` | float | Rate of games ending in checkmate (any side) |
| `checkmate_rate_std` | float | Standard deviation |
| `timeout_rate_mean` | float | Rate of games ending by timeout |
| `timeout_rate_std` | float | Standard deviation |
| `resignation_rate_mean` | float | Rate of games ending by resignation |
| `resignation_rate_std` | float | Standard deviation |
| `abandonment_rate_mean` | float | Rate of games ending by abandonment |
| `abandonment_rate_std` | float | Standard deviation |
| `draw_rate_mean` | float | Rate of drawn games |
| `draw_rate_std` | float | Standard deviation |

**Note**: These are "combined" rates (both wins and losses), providing an overall termination profile.

---

## `opponent_analysis`

Information about opponents encountered by trusted players.

### `trusted_players`

List of objects with details about each trusted player in the baseline:

| Attribute | Type | Description |
|-----------|------|-------------|
| `username` | string | Chess.com username |
| `total_games` | int | Number of games analyzed |
| `avg_rating` | float | Average rating during analyzed period |
| `rating_range` | string | Min-max rating range (e.g., "1500-1650") |
| `trustworthy_games` | int | Games vs verified fair opponents |
| `unique_opponents` | int | Number of unique opponents faced |

### `trustable_frequent_opponents`

List of opponent usernames who:
- Were played frequently (statistically significant)
- Have not been banned for fair play violations

**Usage**: These opponents can be considered reliable for baseline comparisons.

### `banned_opponents_encountered`

List of opponent usernames with fair play violations. Games against these players are excluded from trustworthy statistics.

---

## `players`

Array of individual player summary objects. Each contains the full per-player analysis:

| Attribute | Type | Description |
|-----------|------|-------------|
| `username` | string | Player's chess.com username |
| `status` | string | `"success"`, `"no_games"`, or `"error"` |
| `generated_at` | string | ISO 8601 timestamp |
| `days_back` | int/null | Days of history fetched (null = all) |
| `fetch_all_history` | bool | Whether all available history was fetched |
| `time_classes` | list[str] | Time controls included |
| `total_games` | int | Total games matching criteria |
| `trustworthy_games` | int | Games vs non-banned opponents |
| `untrustworthy_games` | int | Games vs banned opponents |
| `positions_extracted` | int | Positions analyzed |
| `unique_opponents` | int | Unique opponents faced |
| `banned_opponents_count` | int | Banned opponents encountered |
| `frequent_opponents_count` | int | Statistically frequent opponents |
| `elo_segments_by_player` | int | Number of 200-Elo segments (player) |
| `elo_segments_by_opponent` | int | Number of 200-Elo segments (opponent) |
| `elo_analysis` | object | Detailed Elo statistics |
| `result_patterns` | object | Win/loss/draw patterns |
| `termination_patterns` | object | Detailed termination breakdown |
| `timeout_analysis` | object | Timeout win analysis |
| `opening_book_summary` | object | Opening repertoire stats |

---

## Per-Player `elo_analysis`

| Attribute | Type | Description |
|-----------|------|-------------|
| `elo_start` | int | Rating at start of period |
| `elo_end` | int | Rating at end of period |
| `elo_change` | int | Net rating change |
| `elo_min` | int | Minimum rating during period |
| `elo_max` | int | Maximum rating during period |
| `elo_range` | int | Rating volatility (max - min) |
| `elo_avg` | float | Average rating |
| `elo_std` | float | Rating standard deviation |
| `total_games` | int | Games analyzed |
| `wins` | int | Total wins |
| `losses` | int | Total losses |
| `draws` | int | Total draws |
| `win_rate` | float | Win percentage (0.0-1.0) |
| `loss_rate` | float | Loss percentage |
| `current_streak` | int | Current streak (+ve=wins, -ve=losses) |
| `longest_win_streak` | int | Longest winning streak |
| `longest_loss_streak` | int | Longest losing streak |
| `streak_volatility` | float | Frequency of streak changes |
| `upsets` | int | Wins vs significantly higher-rated opponents |
| `upset_rate` | float | Upset rate among wins |
| `major_upsets` | int | Wins vs much higher-rated opponents |
| `losses_to_lower` | int | Losses to lower-rated opponents |
| `losses_to_lower_rate` | float | Rate of losses to lower-rated |
| `suspicious_losses` | int | Losses flagged as unusual |
| `elo_drops` | int | Significant rating drops |
| `elo_recoveries` | int | Recoveries after drops |
| `rating_manipulation_score` | float | Composite suspicion score (0.0-1.0) |

---

## Per-Player `result_patterns`

| Attribute | Type | Description |
|-----------|------|-------------|
| `wins_by_checkmate` | int | Wins ending in checkmate |
| `wins_by_resignation` | int | Wins by opponent resignation |
| `wins_by_timeout` | int | Wins by opponent timeout |
| `losses_by_checkmate` | int | Losses by checkmate |
| `losses_by_resignation` | int | Losses by resignation |
| `losses_by_timeout` | int | Losses by timeout |
| `draws_total` | int | Total draws |
| `checkmate_rate` | float | Combined checkmate rate |
| `resignation_rate` | float | Combined resignation rate |
| `timeout_rate` | float | Combined timeout rate |
| `result_entropy` | float | Randomness of results |
| `run_test_p_value` | float | Wald-Wolfowitz runs test p-value |
| `games_by_hour` | dict | Distribution by hour of day |
| `avg_games_per_session` | float | Average session length |
| `max_games_per_session` | int | Longest session |

---

## Per-Player `termination_patterns`

Comprehensive breakdown of how games ended:

### Checkmate
| Attribute | Type | Description |
|-----------|------|-------------|
| `win_checkmate` | int | Games won by checkmate |
| `loss_checkmate` | int | Games lost by checkmate |
| `combined_checkmate` | int | Total checkmates |
| `checkmate_rate` | float | Checkmate rate |

### Timeout
| Attribute | Type | Description |
|-----------|------|-------------|
| `win_timeout` | int | Games won on time |
| `loss_timeout` | int | Games lost on time |
| `draw_timeout` | int | Draws by mutual time trouble |
| `combined_timeout` | int | Total timeouts |
| `timeout_rate` | float | Timeout rate |

### Resignation
| Attribute | Type | Description |
|-----------|------|-------------|
| `win_resignation` | int | Opponent resigned |
| `loss_resignation` | int | Player resigned |
| `combined_resignation` | int | Total resignations |
| `resignation_rate` | float | Resignation rate |

### Abandonment
| Attribute | Type | Description |
|-----------|------|-------------|
| `win_abandonment` | int | Opponent abandoned |
| `loss_abandonment` | int | Player abandoned |
| `combined_abandonment` | int | Total abandonments |
| `abandonment_rate` | float | Abandonment rate |

### Draw Types
| Attribute | Type | Description |
|-----------|------|-------------|
| `draw_stalemate` | int | Stalemate draws |
| `draw_repetition` | int | Threefold repetition |
| `draw_insufficient` | int | Insufficient material |
| `draw_50move` | int | 50-move rule |
| `draw_agreement` | int | Draw by agreement |
| `draw_other` | int | Other draw types |
| `combined_draw` | int | Total draws |
| `draw_rate` | float | Draw rate |

### Other
| Attribute | Type | Description |
|-----------|------|-------------|
| `other_terminations` | int | Unclassified terminations |
| `other_rate` | float | Other termination rate |

---

## Per-Player `timeout_analysis`

| Attribute | Type | Description |
|-----------|------|-------------|
| `total_wins` | int | Total wins |
| `timeout_wins` | int | Wins by timeout |
| `timeout_win_rate` | float | Timeout wins / total wins |
| `timeout_wins_behind` | int | Timeout wins while behind |
| `timeout_wins_way_behind` | int | Timeout wins while significantly behind |
| `behind_rate` | float | Behind rate among timeout wins |
| `way_behind_rate` | float | Way behind rate |

---

## Per-Player `opening_book_summary`

| Attribute | Type | Description |
|-----------|------|-------------|
| `unique_positions` | int | Unique positions reached |
| `common_positions` | int | Positions reached multiple times |
| `avg_opening_depth` | float | Average moves before leaving book |

---

## Example Usage

```python
import json

with open("data/trusted/combined_baseline.json") as f:
    baseline = json.load(f)

# Check if a player's manipulation score is suspicious
suspect_score = 0.45
threshold = (
    baseline["elo_baseline"]["manipulation_score_mean"] +
    2 * baseline["elo_baseline"]["manipulation_score_std"]
)
if suspect_score > threshold:
    print(f"Score {suspect_score} exceeds threshold {threshold:.3f}")

# Get trusted players with their ratings
for player in baseline["opponent_analysis"]["trusted_players"]:
    print(f"{player['username']}: {player['avg_rating']} ({player['total_games']} games)")
```

---

## Related Files

- Per-player data: `data/trusted/{username}/summary.json`
- Frequent opponents: `data/trusted/{username}/frequent_opponents.json`
- Elo segments: `data/trusted/{username}/elo_segments.json`
- Game data: `data/trusted/{username}/games.parquet`
- Position data: `data/trusted/{username}/positions.parquet`
